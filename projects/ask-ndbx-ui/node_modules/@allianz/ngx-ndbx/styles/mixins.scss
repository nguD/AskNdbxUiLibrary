@import "tokens";

// Register current theme with a name; overwrite currently used tokens
/// @access public
/// @param {String} $theme - the token map of the theme
/// @param {String} $name - the name of the new theme
/// @param {String} $base - the theme used as a token base for the new theme
/// @example - @include($my-tokens, testTheme, ndbx);
@mixin nx-register-theme($theme, $name, $base: null) {

  @if ($base == null) {
    $nx-theme: map-merge($nx-theme, $theme) !global;
  } @else {
      $parent-theme: map-get($themes, $base);
      @if ($parent-theme == null) {
        @error 'Theme: parent theme `' + $parent-name + '` is not registered or imported.';
      }
      // overwrite the already existing tokens by merging:
      // new tokens + overwritten ndbx tokens + base ndbx tokens
      // global is needed to change a variable value from a local scope
      $nx-theme: map-merge($parent-theme, $theme) !global;
  }
  $themes: add-theme($themes, $name, $nx-theme) !global;
}

// Compile theme tokens to css
/// @access public
/// @returns injected into the :root scope css variable declarations
/// @param {String} $theme-name - the name of theme to build
/// @example -  @include nx-build-theme(ndbx)
@mixin nx-build-theme($theme-name: ndbx) {

  $theme: map-get($themes, $theme-name);

  :root {
    @each $name, $value in $theme {
      $parentValue: map-get($theme, $value);
      @if ($parentValue != null) {
        $value: var(--#{$value});
      }
      @include _css-var($name, $value);
    }
  }

  body {
    color: v(text-01);
  }
}

/// @access public
/// @returns different type styles per token.
/// @param {String} $name - the name of the token to get the styles for
/// @example -  @include type-style('body-short-01');
@mixin type-style($name) {
  @include nx--type-style($name);
}

// Create a custom property declaration
/// @access private
@mixin _css-var($name, $value) {
  // sass-lint dies with a fatal error if you use
  // --${$name}
  // https://github.com/sasstools/sass-lint/issues/877
  #{"--"+$name}: #{$value};
}

/// Helper mixin to include the styles for a given token in any selector in your
/// project.
/// @access public
/// @param {String} $name - the name of the token to get the styles for
/// @param {?Map} $breakpoints - if set provides media queries for the given breakpoints
@mixin nx--type-style($name) {
  @include var(font-size, #{$name}-font-size);
  @include var(line-height, #{$name}-line-height);
  @include var(font-weight, #{$name}-font-weight);
  @include var(letter-spacing, #{$name}-letter-spacing);
}


// Helps you to create css property definitions with a static fallback value for IE11
// and creates a css var selector.
// if $tokenName is a map itself use $varName to specify the key, e.g. used for button tokens
/// @access public
/// @param {String} $property - css tyle property (e.g. background)
/// @param {String} $token - token key to be applied to the $property
/// @returns a css style definition (e.g. background: var(--button-background);)
/// @example - @include(background, button-background)
@mixin var($property, $token) {
  $fallbackValue: _get-fallback-value($token);

  #{$property}: $fallbackValue;
  #{$property}: var(--#{$token}, $fallbackValue);
}

// helper to get css var with a fallback value
// returns var(--<$token>, <fallback-value>
@function v($token) {
  $fallbackValue: _get-fallback-value($token);

  @return var(--#{$token}, $fallbackValue);
}

// returns the raw value of a token
// e.g. useful for IE11 fallback values that have to be made custom
// and not with the var() mixin, like in transitions
@function nx-theme-value($token) {
  @return _get-fallback-value($token);
}

/// Gets a css variable with a fallback value
/// @access public
/// @param {String} $token - token key to be used
/// @returns var(--<$token>, <fallback-value>
/// @example - background: nx-theme(primary-action)
@function nx-theme($token) {
  @return v($token);
}

/// @access private
// get the fallback value from a token key.
@function _get-fallback-value($token) {
  $fallbackValue: _nx-deep-find-value($nx-theme, $token, map-get($nx-theme, $token));

  @if ($fallbackValue == null) {
    @error 'Theme: cannot find value for key `' + $token + '`';
  }

  @return $fallbackValue;
}

// Helper function to make it possible to reuse keys from the same map.
// Example:
// $theme: (
//    global-color: #123456,
//    component-color: global-color
// );
// This makes it possible to reuse "global-color" inside the theming map.
// Functions and mixins like nx-theme(), v() and var() will take care of resolving
// these references
/// @access private
@function _nx-deep-find-value($theme, $key, $value) {
  $parent-value: map-get($theme, $value);

  @if ($parent-value != null) {
    @return _nx-deep-find-value($theme, $value, $parent-value);
  }

  @return $value;
}

// Adds a new theme to the list of available themes
@function add-theme($themes, $key, $value: null) {
  $new-theme: ($key: $value);
  @return map-merge($themes, $new-theme);
}
