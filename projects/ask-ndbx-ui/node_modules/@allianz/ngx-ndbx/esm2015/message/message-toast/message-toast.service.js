/**
 * @fileoverview added by tsickle
 * Generated from: message/message-toast/message-toast.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, InjectionToken, Inject, Optional, SkipSelf } from '@angular/core';
import { Overlay, OverlayConfig } from '@angular/cdk/overlay';
import { ComponentPortal, PortalInjector, TemplatePortal } from '@angular/cdk/portal';
import { NxMessageToastComponent } from './message-toast.component';
import { NxMessageToastConfig, NxMessageToastData } from './message-toast-config';
import { NxMessageToastRef } from './message-toast-ref';
import { LiveAnnouncer } from '@angular/cdk/a11y';
import { NxMessageModule } from '../message.module';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "@angular/cdk/a11y";
import * as i3 from "../message.module";
/**
 * Injection token that can be used to specify default message toast.
 * @type {?}
 */
export const NX_MESSAGE_TOAST_DEFAULT_CONFIG = new InjectionToken('NX_MESSAGE_TOAST_DEFAULT_CONFIG');
/**
 * A service for dispatching and displaying toast messages.
 */
export class NxMessageToastService {
    /**
     * @param {?} _overlay
     * @param {?} _injector
     * @param {?} _live
     * @param {?} _parentMessageToastService
     * @param {?} _defaultConfig
     */
    constructor(_overlay, _injector, _live, _parentMessageToastService, _defaultConfig) {
        this._overlay = _overlay;
        this._injector = _injector;
        this._live = _live;
        this._parentMessageToastService = _parentMessageToastService;
        this._defaultConfig = _defaultConfig;
        /**
         * Reference to the current message toast in the view *at this level* (in the Angular injector tree).
         * If there is a parent message toast service, all operations should delegate to that parent
         * via `_oldToastMessageRef`.
         */
        this._toastRefAtThisLevel = null;
    }
    /**
     * Reference to the currently opened message toastat *any* level.
     * @return {?}
     */
    get _oldToastMessageRef() {
        /** @type {?} */
        const parent = this._parentMessageToastService;
        return parent ? parent._oldToastMessageRef : this._toastRefAtThisLevel;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set _oldToastMessageRef(value) {
        if (this._parentMessageToastService) {
            this._parentMessageToastService._oldToastMessageRef = value;
        }
        else {
            this._toastRefAtThisLevel = value;
        }
    }
    /**
     * Creates and dispatches a message toastwith a custom text.
     *
     * @param {?} text Text to be used for the message toast.
     * @param {?=} config Extra configuration for the message toast.
     * @return {?}
     */
    open(text, config) {
        /** @type {?} */
        const currentConfig = Object.assign({}, new NxMessageToastConfig(), this._defaultConfig, config);
        /** @type {?} */
        const overlayRef = this._createOverlay(currentConfig);
        /** @type {?} */
        const injector = this._createInjector(currentConfig, new NxMessageToastData(text), this._injector);
        /** @type {?} */
        const componentPortal = new ComponentPortal(NxMessageToastComponent, undefined, injector);
        /** @type {?} */
        const componentRef = overlayRef.attach(componentPortal);
        /** @type {?} */
        const toastRef = new NxMessageToastRef(componentRef.instance, overlayRef);
        this._animateToast(toastRef, currentConfig);
        this._oldToastMessageRef = toastRef;
        return this._oldToastMessageRef;
    }
    /**
     * Creates and dispatches a message toastwith a custom template for the content.
     *
     * @param {?} template Template to be used for the message toast.
     * @param {?=} config Extra configuration for the message toast.
     * @return {?}
     */
    openFromTemplate(template, config) {
        /** @type {?} */
        const currentConfig = Object.assign({}, new NxMessageToastConfig(), this._defaultConfig, config);
        /** @type {?} */
        const overlayRef = this._createOverlay(currentConfig);
        /** @type {?} */
        const container = this._attachToastComponent(overlayRef, currentConfig);
        /** @type {?} */
        const toastRef = new NxMessageToastRef(container, overlayRef);
        /** @type {?} */
        const portal = new TemplatePortal(template, (/** @type {?} */ (null)), toastRef);
        container.attachTemplatePortal(portal);
        this._animateToast(toastRef, currentConfig);
        this._oldToastMessageRef = toastRef;
        return this._oldToastMessageRef;
    }
    // Attaches the message toastcontainer component to the overlay.
    /**
     * @private
     * @param {?} overlayRef
     * @param {?} config
     * @return {?}
     */
    _attachToastComponent(overlayRef, config) {
        /** @type {?} */
        const injector = this._createInjector(config, null, this._injector);
        /** @type {?} */
        const containerPortal = new ComponentPortal(NxMessageToastComponent, null, injector);
        /** @type {?} */
        const containerRef = overlayRef.attach(containerPortal);
        containerRef.instance.config = config;
        return containerRef.instance;
    }
    // Creates a new overlay and places it in the correct place.
    /**
     * @private
     * @param {?} config
     * @return {?}
     */
    _createOverlay(config) {
        /** @type {?} */
        const overlayConfig = new OverlayConfig();
        /** @type {?} */
        const positionStrategy = this._overlay.position().global();
        positionStrategy.bottom('0');
        positionStrategy.centerHorizontally();
        overlayConfig.positionStrategy = positionStrategy;
        return this._overlay.create(overlayConfig);
    }
    /**
     * Animates the old message toastout and the new one in.
     * @private
     * @param {?} toastRef
     * @param {?} config
     * @return {?}
     */
    _animateToast(toastRef, config) {
        // When the message toastis dismissed, clear the reference to it.
        toastRef.afterDismissed().subscribe((/**
         * @return {?}
         */
        () => {
            // Clear the message toastref if it hasn't already been replaced by a newer message toast.
            if (this._oldToastMessageRef === toastRef) {
                this._oldToastMessageRef = null;
            }
            if (config.announcementMessage) {
                this._live.clear();
            }
        }));
        if (this._oldToastMessageRef) {
            // If a message toastis opened, dismiss it and enter the
            // new message toastafter exit animation is complete.
            this._oldToastMessageRef.afterDismissed().subscribe((/**
             * @return {?}
             */
            () => {
                toastRef.toastInstance.enter();
            }));
            this._oldToastMessageRef.dismiss();
        }
        else {
            // If no message toastis in view, enter the message toast.
            toastRef.toastInstance.enter();
        }
        // If a message toastduration is provided, set up dismiss based on after the message toastis opened.
        if (config.duration && config.duration > 0) {
            toastRef.afterOpened().subscribe((/**
             * @return {?}
             */
            () => toastRef._dismissAfter((/** @type {?} */ (config.duration)))));
        }
        if (config.announcementMessage) {
            this._live.announce(config.announcementMessage, config.politeness);
        }
    }
    /**
     * @private
     * @param {?} config
     * @param {?} data
     * @param {?} injector
     * @return {?}
     */
    _createInjector(config, data, injector) {
        /** @type {?} */
        const tokens = new WeakMap();
        tokens.set(NxMessageToastConfig, config);
        tokens.set(NxMessageToastData, data);
        return new PortalInjector(injector, tokens);
    }
    /**
     * Dismisses the currently visible message toast.
     * @return {?}
     */
    dismiss() {
        if (this._oldToastMessageRef) {
            this._oldToastMessageRef.dismiss();
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this._toastRefAtThisLevel) {
            this._toastRefAtThisLevel.dismiss();
        }
    }
}
NxMessageToastService.decorators = [
    { type: Injectable, args: [{ providedIn: NxMessageModule },] }
];
/** @nocollapse */
NxMessageToastService.ctorParameters = () => [
    { type: Overlay },
    { type: Injector },
    { type: LiveAnnouncer },
    { type: NxMessageToastService, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: NxMessageToastConfig, decorators: [{ type: Optional }, { type: Inject, args: [NX_MESSAGE_TOAST_DEFAULT_CONFIG,] }] }
];
/** @nocollapse */ NxMessageToastService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function NxMessageToastService_Factory() { return new NxMessageToastService(i0.ɵɵinject(i1.Overlay), i0.ɵɵinject(i0.INJECTOR), i0.ɵɵinject(i2.LiveAnnouncer), i0.ɵɵinject(NxMessageToastService, 12), i0.ɵɵinject(NX_MESSAGE_TOAST_DEFAULT_CONFIG, 8)); }, token: NxMessageToastService, providedIn: i3.NxMessageModule });
if (false) {
    /**
     * Reference to the current message toast in the view *at this level* (in the Angular injector tree).
     * If there is a parent message toast service, all operations should delegate to that parent
     * via `_oldToastMessageRef`.
     * @type {?}
     * @private
     */
    NxMessageToastService.prototype._toastRefAtThisLevel;
    /**
     * @type {?}
     * @private
     */
    NxMessageToastService.prototype._overlay;
    /**
     * @type {?}
     * @private
     */
    NxMessageToastService.prototype._injector;
    /**
     * @type {?}
     * @private
     */
    NxMessageToastService.prototype._live;
    /**
     * @type {?}
     * @private
     */
    NxMessageToastService.prototype._parentMessageToastService;
    /**
     * @type {?}
     * @private
     */
    NxMessageToastService.prototype._defaultConfig;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS10b2FzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsbGlhbnovbmd4LW5kYngvIiwic291cmNlcyI6WyJtZXNzYWdlL21lc3NhZ2UtdG9hc3QvbWVzc2FnZS10b2FzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQTZCLGNBQWMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN2SSxPQUFPLEVBQUUsT0FBTyxFQUFjLGFBQWEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7Ozs7Ozs7OztBQUdwRCxNQUFNLE9BQU8sK0JBQStCLEdBQzFDLElBQUksY0FBYyxDQUF1QixpQ0FBaUMsQ0FBQzs7OztBQUk3RSxNQUFNLE9BQU8scUJBQXFCOzs7Ozs7OztJQXVCaEMsWUFDVSxRQUFpQixFQUNqQixTQUFtQixFQUNuQixLQUFvQixFQUNJLDBCQUFpRCxFQUNwQixjQUFvQztRQUp6RixhQUFRLEdBQVIsUUFBUSxDQUFTO1FBQ2pCLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFDbkIsVUFBSyxHQUFMLEtBQUssQ0FBZTtRQUNJLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBdUI7UUFDcEIsbUJBQWMs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QUksUUFBUTtZQXRDaEIsb0JBQW9CLHVCQXVDeEIsUUFBUSxZQUFJLE1BQU0sU0FBQywrQkFBK0I7Ozs7Ozs7Ozs7O0lBckJyRCxxREFBOEQ7Ozs7O0lBaUI1RCx5Q0FBeUI7Ozs7O0lBQ3pCLDBDQUEyQjs7Ozs7SUFDM0Isc0NBQTRCOzs7OztJQUM1QiwyREFBaUY7Ozs7O0lBQ2pGLCtDQUFpRyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBDb21wb25lbnRSZWYsIFRlbXBsYXRlUmVmLCBJbmplY3Rpb25Ub2tlbiwgSW5qZWN0LCBPcHRpb25hbCwgU2tpcFNlbGYsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT3ZlcmxheSwgT3ZlcmxheVJlZiwgT3ZlcmxheUNvbmZpZyB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgUG9ydGFsSW5qZWN0b3IsIFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBOeE1lc3NhZ2VUb2FzdENvbXBvbmVudCB9IGZyb20gJy4vbWVzc2FnZS10b2FzdC5jb21wb25lbnQnO1xuaW1wb3J0IHsgTnhNZXNzYWdlVG9hc3RDb25maWcsIE54TWVzc2FnZVRvYXN0RGF0YSB9IGZyb20gJy4vbWVzc2FnZS10b2FzdC1jb25maWcnO1xuaW1wb3J0IHsgTnhNZXNzYWdlVG9hc3RSZWYgfSBmcm9tICcuL21lc3NhZ2UtdG9hc3QtcmVmJztcbmltcG9ydCB7IExpdmVBbm5vdW5jZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvYTExeSc7XG5pbXBvcnQgeyBOeE1lc3NhZ2VNb2R1bGUgfSBmcm9tICcuLi9tZXNzYWdlLm1vZHVsZSc7XG5cbi8qKiBJbmplY3Rpb24gdG9rZW4gdGhhdCBjYW4gYmUgdXNlZCB0byBzcGVjaWZ5IGRlZmF1bHQgbWVzc2FnZSB0b2FzdC4gKi9cbmV4cG9ydCBjb25zdCBOWF9NRVNTQUdFX1RPQVNUX0RFRkFVTFRfQ09ORklHID1cbiAgbmV3IEluamVjdGlvblRva2VuPE54TWVzc2FnZVRvYXN0Q29uZmlnPignTlhfTUVTU0FHRV9UT0FTVF9ERUZBVUxUX0NPTkZJRycpO1xuXG4vKiogQSBzZXJ2aWNlIGZvciBkaXNwYXRjaGluZyBhbmQgZGlzcGxheWluZyB0b2FzdCBtZXNzYWdlcy4gKi9cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogTnhNZXNzYWdlTW9kdWxlIH0pXG5leHBvcnQgY2xhc3MgTnhNZXNzYWdlVG9hc3RTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuLyoqXG4gKiBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgbWVzc2FnZSB0b2FzdCBpbiB0aGUgdmlldyAqYXQgdGhpcyBsZXZlbCogKGluIHRoZSBBbmd1bGFyIGluamVjdG9yIHRyZWUpLlxuICogSWYgdGhlcmUgaXMgYSBwYXJlbnQgbWVzc2FnZSB0b2FzdCBzZXJ2aWNlLCBhbGwgb3BlcmF0aW9ucyBzaG91bGQgZGVsZWdhdGUgdG8gdGhhdCBwYXJlbnRcbiAqIHZpYSBgX29sZFRvYXN0TWVzc2FnZVJlZmAuXG4gKi9cbiAgcHJpdmF0ZSBfdG9hc3RSZWZBdFRoaXNMZXZlbDogTnhNZXNzYWdlVG9hc3RSZWYgfCBudWxsID0gbnVsbDtcblxuICAvKiogUmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgb3BlbmVkIG1lc3NhZ2UgdG9hc3RhdCAqYW55KiBsZXZlbC4gKi9cbiAgZ2V0IF9vbGRUb2FzdE1lc3NhZ2VSZWYoKTogTnhNZXNzYWdlVG9hc3RSZWYgfCBudWxsIHtcbiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLl9wYXJlbnRNZXNzYWdlVG9hc3RTZXJ2aWNlO1xuICAgIHJldHVybiBwYXJlbnQgPyBwYXJlbnQuX29sZFRvYXN0TWVzc2FnZVJlZiA6IHRoaXMuX3RvYXN0UmVmQXRUaGlzTGV2ZWw7XG4gIH1cblxuICBzZXQgX29sZFRvYXN0TWVzc2FnZVJlZih2YWx1ZTogTnhNZXNzYWdlVG9hc3RSZWYgfCBudWxsKSB7XG4gICAgaWYgKHRoaXMuX3BhcmVudE1lc3NhZ2VUb2FzdFNlcnZpY2UpIHtcbiAgICAgIHRoaXMuX3BhcmVudE1lc3NhZ2VUb2FzdFNlcnZpY2UuX29sZFRvYXN0TWVzc2FnZVJlZiA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl90b2FzdFJlZkF0VGhpc0xldmVsID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfb3ZlcmxheTogT3ZlcmxheSxcbiAgICBwcml2YXRlIF9pbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBfbGl2ZTogTGl2ZUFubm91bmNlcixcbiAgICBAT3B0aW9uYWwoKSBAU2tpcFNlbGYoKSBwcml2YXRlIF9wYXJlbnRNZXNzYWdlVG9hc3RTZXJ2aWNlOiBOeE1lc3NhZ2VUb2FzdFNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChOWF9NRVNTQUdFX1RPQVNUX0RFRkFVTFRfQ09ORklHKSBwcml2YXRlIF9kZWZhdWx0Q29uZmlnOiBOeE1lc3NhZ2VUb2FzdENvbmZpZykgeyB9XG5cbiAgLyoqIENyZWF0ZXMgYW5kIGRpc3BhdGNoZXMgYSBtZXNzYWdlIHRvYXN0d2l0aCBhIGN1c3RvbSB0ZXh0LlxuICAgKlxuICAgKiBAcGFyYW0gdGV4dCBUZXh0IHRvIGJlIHVzZWQgZm9yIHRoZSBtZXNzYWdlIHRvYXN0LlxuICAgKiBAcGFyYW0gY29uZmlnIEV4dHJhIGNvbmZpZ3VyYXRpb24gZm9yIHRoZSBtZXNzYWdlIHRvYXN0LlxuICAqL1xuICBvcGVuKHRleHQ6IHN0cmluZywgY29uZmlnPzogTnhNZXNzYWdlVG9hc3RDb25maWcpOiBOeE1lc3NhZ2VUb2FzdFJlZiB7XG4gICAgY29uc3QgY3VycmVudENvbmZpZyA9IHsgLi4ubmV3IE54TWVzc2FnZVRvYXN0Q29uZmlnKCksIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsIC4uLmNvbmZpZyB9O1xuICAgIGNvbnN0IG92ZXJsYXlSZWYgPSB0aGlzLl9jcmVhdGVPdmVybGF5KGN1cnJlbnRDb25maWcpO1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IoY3VycmVudENvbmZpZywgbmV3IE54TWVzc2FnZVRvYXN0RGF0YSh0ZXh0KSwgdGhpcy5faW5qZWN0b3IpO1xuXG4gICAgY29uc3QgY29tcG9uZW50UG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChOeE1lc3NhZ2VUb2FzdENvbXBvbmVudCwgdW5kZWZpbmVkLCBpbmplY3Rvcik7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gb3ZlcmxheVJlZi5hdHRhY2goY29tcG9uZW50UG9ydGFsKTtcbiAgICBjb25zdCB0b2FzdFJlZiA9IG5ldyBOeE1lc3NhZ2VUb2FzdFJlZihjb21wb25lbnRSZWYuaW5zdGFuY2UsIG92ZXJsYXlSZWYpO1xuXG4gICAgdGhpcy5fYW5pbWF0ZVRvYXN0KHRvYXN0UmVmLCBjdXJyZW50Q29uZmlnKTtcbiAgICB0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYgPSB0b2FzdFJlZjtcbiAgICByZXR1cm4gdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmO1xuICB9XG5cbiAgLyoqIENyZWF0ZXMgYW5kIGRpc3BhdGNoZXMgYSBtZXNzYWdlIHRvYXN0d2l0aCBhIGN1c3RvbSB0ZW1wbGF0ZSBmb3IgdGhlIGNvbnRlbnQuXG4gICAqXG4gICAqIEBwYXJhbSB0ZW1wbGF0ZSBUZW1wbGF0ZSB0byBiZSB1c2VkIGZvciB0aGUgbWVzc2FnZSB0b2FzdC5cbiAgICogQHBhcmFtIGNvbmZpZyBFeHRyYSBjb25maWd1cmF0aW9uIGZvciB0aGUgbWVzc2FnZSB0b2FzdC5cbiAgKi9cbiAgb3BlbkZyb21UZW1wbGF0ZSh0ZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PiwgY29uZmlnPzogTnhNZXNzYWdlVG9hc3RDb25maWcpOiBOeE1lc3NhZ2VUb2FzdFJlZiB7XG4gICAgY29uc3QgY3VycmVudENvbmZpZyA9IHsgLi4ubmV3IE54TWVzc2FnZVRvYXN0Q29uZmlnKCksIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsIC4uLmNvbmZpZyB9O1xuICAgIGNvbnN0IG92ZXJsYXlSZWYgPSB0aGlzLl9jcmVhdGVPdmVybGF5KGN1cnJlbnRDb25maWcpO1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuX2F0dGFjaFRvYXN0Q29tcG9uZW50KG92ZXJsYXlSZWYsIGN1cnJlbnRDb25maWcpO1xuICAgIGNvbnN0IHRvYXN0UmVmID0gbmV3IE54TWVzc2FnZVRvYXN0UmVmKGNvbnRhaW5lciwgb3ZlcmxheVJlZik7XG4gICAgY29uc3QgcG9ydGFsID0gbmV3IFRlbXBsYXRlUG9ydGFsKHRlbXBsYXRlLCBudWxsISwgdG9hc3RSZWYpO1xuXG4gICAgY29udGFpbmVyLmF0dGFjaFRlbXBsYXRlUG9ydGFsKHBvcnRhbCk7XG4gICAgdGhpcy5fYW5pbWF0ZVRvYXN0KHRvYXN0UmVmLCBjdXJyZW50Q29uZmlnKTtcbiAgICB0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYgPSB0b2FzdFJlZjtcbiAgICByZXR1cm4gdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmO1xuICB9XG5cbiAgLy8gQXR0YWNoZXMgdGhlIG1lc3NhZ2UgdG9hc3Rjb250YWluZXIgY29tcG9uZW50IHRvIHRoZSBvdmVybGF5LlxuICBwcml2YXRlIF9hdHRhY2hUb2FzdENvbXBvbmVudChvdmVybGF5UmVmOiBPdmVybGF5UmVmLCBjb25maWc6IE54TWVzc2FnZVRvYXN0Q29uZmlnKTogTnhNZXNzYWdlVG9hc3RDb21wb25lbnQge1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IoY29uZmlnLCBudWxsLCB0aGlzLl9pbmplY3Rvcik7XG4gICAgY29uc3QgY29udGFpbmVyUG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChOeE1lc3NhZ2VUb2FzdENvbXBvbmVudCwgbnVsbCwgaW5qZWN0b3IpO1xuICAgIGNvbnN0IGNvbnRhaW5lclJlZjogQ29tcG9uZW50UmVmPE54TWVzc2FnZVRvYXN0Q29tcG9uZW50PiA9IG92ZXJsYXlSZWYuYXR0YWNoKGNvbnRhaW5lclBvcnRhbCk7XG4gICAgY29udGFpbmVyUmVmLmluc3RhbmNlLmNvbmZpZyA9IGNvbmZpZztcblxuICAgIHJldHVybiBjb250YWluZXJSZWYuaW5zdGFuY2U7XG4gIH1cblxuICAvLyBDcmVhdGVzIGEgbmV3IG92ZXJsYXkgYW5kIHBsYWNlcyBpdCBpbiB0aGUgY29ycmVjdCBwbGFjZS5cbiAgcHJpdmF0ZSBfY3JlYXRlT3ZlcmxheShjb25maWc6IE54TWVzc2FnZVRvYXN0Q29uZmlnKTogT3ZlcmxheVJlZiB7XG4gICAgY29uc3Qgb3ZlcmxheUNvbmZpZyA9IG5ldyBPdmVybGF5Q29uZmlnKCk7XG4gICAgY29uc3QgcG9zaXRpb25TdHJhdGVneSA9IHRoaXMuX292ZXJsYXkucG9zaXRpb24oKS5nbG9iYWwoKTtcblxuICAgIHBvc2l0aW9uU3RyYXRlZ3kuYm90dG9tKCcwJyk7XG4gICAgcG9zaXRpb25TdHJhdGVneS5jZW50ZXJIb3Jpem9udGFsbHkoKTtcbiAgICBvdmVybGF5Q29uZmlnLnBvc2l0aW9uU3RyYXRlZ3kgPSBwb3NpdGlvblN0cmF0ZWd5O1xuXG4gICAgcmV0dXJuIHRoaXMuX292ZXJsYXkuY3JlYXRlKG92ZXJsYXlDb25maWcpO1xuICB9XG5cbiAgLyoqIEFuaW1hdGVzIHRoZSBvbGQgbWVzc2FnZSB0b2FzdG91dCBhbmQgdGhlIG5ldyBvbmUgaW4uICovXG4gIHByaXZhdGUgX2FuaW1hdGVUb2FzdCh0b2FzdFJlZjogTnhNZXNzYWdlVG9hc3RSZWYsIGNvbmZpZzogTnhNZXNzYWdlVG9hc3RDb25maWcpIHtcbiAgICAvLyBXaGVuIHRoZSBtZXNzYWdlIHRvYXN0aXMgZGlzbWlzc2VkLCBjbGVhciB0aGUgcmVmZXJlbmNlIHRvIGl0LlxuICAgIHRvYXN0UmVmLmFmdGVyRGlzbWlzc2VkKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIC8vIENsZWFyIHRoZSBtZXNzYWdlIHRvYXN0cmVmIGlmIGl0IGhhc24ndCBhbHJlYWR5IGJlZW4gcmVwbGFjZWQgYnkgYSBuZXdlciBtZXNzYWdlIHRvYXN0LlxuICAgICAgaWYgKHRoaXMuX29sZFRvYXN0TWVzc2FnZVJlZiA9PT0gdG9hc3RSZWYpIHtcbiAgICAgICAgdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgaWYgKGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlKSB7XG4gICAgICAgIHRoaXMuX2xpdmUuY2xlYXIoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmICh0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYpIHtcbiAgICAgIC8vIElmIGEgbWVzc2FnZSB0b2FzdGlzIG9wZW5lZCwgZGlzbWlzcyBpdCBhbmQgZW50ZXIgdGhlXG4gICAgICAvLyBuZXcgbWVzc2FnZSB0b2FzdGFmdGVyIGV4aXQgYW5pbWF0aW9uIGlzIGNvbXBsZXRlLlxuICAgICAgdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmLmFmdGVyRGlzbWlzc2VkKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdG9hc3RSZWYudG9hc3RJbnN0YW5jZS5lbnRlcigpO1xuICAgIH0pO1xuICAgICAgdGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmLmRpc21pc3MoKTtcblxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBJZiBubyBtZXNzYWdlIHRvYXN0aXMgaW4gdmlldywgZW50ZXIgdGhlIG1lc3NhZ2UgdG9hc3QuXG4gICAgICB0b2FzdFJlZi50b2FzdEluc3RhbmNlLmVudGVyKCk7XG4gICAgfVxuXG4gICAgLy8gSWYgYSBtZXNzYWdlIHRvYXN0ZHVyYXRpb24gaXMgcHJvdmlkZWQsIHNldCB1cCBkaXNtaXNzIGJhc2VkIG9uIGFmdGVyIHRoZSBtZXNzYWdlIHRvYXN0aXMgb3BlbmVkLlxuICAgIGlmIChjb25maWcuZHVyYXRpb24gJiYgY29uZmlnLmR1cmF0aW9uID4gMCkge1xuICAgICAgdG9hc3RSZWYuYWZ0ZXJPcGVuZWQoKS5zdWJzY3JpYmUoKCkgPT4gdG9hc3RSZWYuX2Rpc21pc3NBZnRlcihjb25maWcuZHVyYXRpb24hKSk7XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlKSB7XG4gICAgICB0aGlzLl9saXZlLmFubm91bmNlKGNvbmZpZy5hbm5vdW5jZW1lbnRNZXNzYWdlLCBjb25maWcucG9saXRlbmVzcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfY3JlYXRlSW5qZWN0b3IoY29uZmlnOiBOeE1lc3NhZ2VUb2FzdENvbmZpZywgZGF0YTogTnhNZXNzYWdlVG9hc3REYXRhLCBpbmplY3RvcjogSW5qZWN0b3IpOiBQb3J0YWxJbmplY3RvciB7XG4gICAgY29uc3QgdG9rZW5zID0gbmV3IFdlYWtNYXAoKTtcbiAgICB0b2tlbnMuc2V0KE54TWVzc2FnZVRvYXN0Q29uZmlnLCBjb25maWcpO1xuICAgIHRva2Vucy5zZXQoTnhNZXNzYWdlVG9hc3REYXRhLCBkYXRhKTtcblxuICAgIHJldHVybiBuZXcgUG9ydGFsSW5qZWN0b3IoaW5qZWN0b3IsIHRva2Vucyk7XG4gIH1cblxuICAvKipcbiAgICogRGlzbWlzc2VzIHRoZSBjdXJyZW50bHkgdmlzaWJsZSBtZXNzYWdlIHRvYXN0LlxuICAgKi9cbiAgZGlzbWlzcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fb2xkVG9hc3RNZXNzYWdlUmVmKSB7XG4gICAgICB0aGlzLl9vbGRUb2FzdE1lc3NhZ2VSZWYuZGlzbWlzcygpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLl90b2FzdFJlZkF0VGhpc0xldmVsKSB7XG4gICAgICB0aGlzLl90b2FzdFJlZkF0VGhpc0xldmVsLmRpc21pc3MoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==