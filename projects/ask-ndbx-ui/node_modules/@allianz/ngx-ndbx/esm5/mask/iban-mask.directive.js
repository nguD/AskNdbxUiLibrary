/**
 * @fileoverview added by tsickle
 * Generated from: iban-mask.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Inject, forwardRef } from '@angular/core';
import * as IBAN from 'iban';
import { NG_VALIDATORS } from '@angular/forms';
import { NxMaskDirective } from './mask.directive';
/** @type {?} */
export var NX_IBAN_MASK_VALIDATORS = {
    provide: NG_VALIDATORS,
    useExisting: forwardRef((/**
     * @return {?}
     */
    function () { return NxIbanMaskDirective; })),
    multi: true
};
/**
 * To use the `NxIbanMaskDirective`, you have to install the **peer dependency** `iban.js`.
 */
var NxIbanMaskDirective = /** @class */ (function () {
    function NxIbanMaskDirective(_elementRef, maskDirective) {
        var _this = this;
        this._elementRef = _elementRef;
        this.maskDirective = maskDirective;
        this._afterInputHook = (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            /** @type {?} */
            var input = (/** @type {?} */ (event.target));
            _this._setCountryCode(input.value.substr(0, 2));
        });
        this._beforePasteHook = (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            // change the country code here if necessary
            /** @type {?} */
            var input = (/** @type {?} */ (event.target));
            /** @type {?} */
            var pastedData = (event.clipboardData || ((/** @type {?} */ (window))).clipboardData).getData('text');
            /** @type {?} */
            var enteredCountryCode = (_this.maskDirective.elementRefValue.substr(0, input.selectionStart)
                + _this.maskDirective.getMaskedString(pastedData, input.selectionStart)).substr(0, 2);
            _this._setCountryCode(enteredCountryCode);
        });
        this.maskDirective.registerAfterInputHook(this._afterInputHook);
        this.maskDirective.registerBeforePasteHook(this._beforePasteHook);
        this.maskDirective.cvaModelChange.subscribe((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var enteredCountryCode = _this.maskDirective.getMaskedString(value).substr(0, 2);
            _this._setCountryCode(enteredCountryCode);
        }));
    }
    /**
     * @private
     * @param {?} code
     * @return {?}
     */
    NxIbanMaskDirective.prototype._setCountryCode = /**
     * @private
     * @param {?} code
     * @return {?}
     */
    function (code) {
        code = code.toUpperCase();
        if (code.length === 2 && this._countryCode !== code) {
            if (this._countryCodeExists(code)) {
                this._countryCode = code;
                this.maskDirective.setMask(this._getMask(this._countryCode));
            }
            else {
                this._countryCode = null;
                this.maskDirective.setMask('SS');
            }
        }
    };
    /**
     * @return {?}
     */
    NxIbanMaskDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        // set only first two letters as I don't know a country yet
        this.maskDirective.mask = 'SS';
        this.maskDirective.convertTo = 'upper';
    };
    /**
     * @private
     * @param {?} countryCode
     * @return {?}
     */
    NxIbanMaskDirective.prototype._getMask = /**
     * @private
     * @param {?} countryCode
     * @return {?}
     */
    function (countryCode) {
        // the countrySpecs of a country contain: countryCode ("DE"), length (22), structure ("F08F10")
        // and an example belonging to each country
        /** @type {?} */
        var countrySpecs = IBAN['countries'][countryCode];
        // 'SS' for country code + '00' for IBAN checksum
        /** @type {?} */
        var mask = 'SS00';
        // split up after every third character
        /** @type {?} */
        var characterDefs = countrySpecs['structure'].match(/.{1,3}/g);
        characterDefs.forEach((/**
         * @param {?} charDef
         * @return {?}
         */
        function (charDef) {
            /** @type {?} */
            var character = charDef[0];
            /** @type {?} */
            var count = Number(charDef.substring(1, 3));
            switch (character) {
                // [0-9]
                case 'F':
                    mask = mask + '0'.repeat(count);
                    break;
                // [0-9A-Za-z]
                case 'A':
                    mask = mask + 'A'.repeat(count);
                    break;
                // [A-Z]
                // 'S' in nxMask does accept also [a-z].
                // There is no option for only accepting capital letters at the moment.
                case 'U':
                    mask = mask + 'S'.repeat(count);
                    break;
            }
        }));
        // insert whitespaces after every 4 characters
        mask = mask.match(/.{1,4}/g).join(' ');
        return mask;
    };
    /**
     * @private
     * @param {?} countryCode
     * @return {?}
     */
    NxIbanMaskDirective.prototype._countryCodeExists = /**
     * @private
     * @param {?} countryCode
     * @return {?}
     */
    function (countryCode) {
        return (!!IBAN['countries'][countryCode]);
    };
    /**
     * @private
     * @return {?}
     */
    NxIbanMaskDirective.prototype._validateFn = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var enteredCountryCode = this._elementRef.nativeElement.value.substr(0, 2);
        if (enteredCountryCode.length === 2 && !this._countryCodeExists(enteredCountryCode)) {
            // immediately show error to user
            this.maskDirective._touch();
            return { nxIbanInvalidCountryError: 'no valid country code' };
        }
        if (!IBAN.isValid(this.maskDirective.getUnmaskedValue())) {
            return { nxIbanParseError: 'no valid iban' };
        }
        return null;
    };
    /** @docs-private */
    /**
     * \@docs-private
     * @return {?}
     */
    NxIbanMaskDirective.prototype.validate = /**
     * \@docs-private
     * @return {?}
     */
    function () {
        return this.maskDirective.validateMask ? this._validateFn() : null;
    };
    NxIbanMaskDirective.decorators = [
        { type: Directive, args: [{
                    selector: 'input[nxIbanMask]',
                    exportAs: 'nxIbanMaskDirective',
                    providers: [
                        NX_IBAN_MASK_VALIDATORS
                    ]
                },] }
    ];
    /** @nocollapse */
    NxIbanMaskDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: NxMaskDirective, decorators: [{ type: Inject, args: [forwardRef((/**
                         * @return {?}
                         */
                        function () { return NxMaskDirective; })),] }] }
    ]; };
    return NxIbanMaskDirective;
}());
export { NxIbanMaskDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    NxIbanMaskDirective.prototype._countryCode;
    /**
     * @type {?}
     * @private
     */
    NxIbanMaskDirective.prototype._afterInputHook;
    /**
     * @type {?}
     * @private
     */
    NxIbanMaskDirective.prototype._beforePasteHook;
    /**
     * @type {?}
     * @private
     */
    NxIbanMaskDirective.prototype._elementRef;
    /**
     * @type {?}
     * @private
     */
    NxIbanMaskDirective.prototype.maskDirective;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWJhbi1tYXNrLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGxpYW56L25neC1uZGJ4L21hc2svIiwic291cmNlcyI6WyJpYmFuLW1hc2suZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRixPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHL0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztBQUVuRCxNQUFNLEtBQU8sdUJBQXVCLEdBQVE7SUFDMUMsT0FBTyxFQUFFLGFBQWE7SUFDdEIsV0FBVyxFQUFFLFVBQVU7OztJQUFDLGNBQU0sT0FBQSxtQkFBbUIsRUFBbkIsQ0FBbUIsRUFBQztJQUNsRCxLQUFLLEVBQUUsSUFBSTtDQUNaOzs7O0FBS0Q7SUFXRSw2QkFDVSxXQUF1QixFQUNvQixhQUE4QjtRQUZuRixpQkFXQztRQVZTLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQ29CLGtCQUFhLEdBQWIsYUFBYSxDQUFpQjtRQVczRSxvQkFBZTs7OztRQUFHLFVBQUMsS0FBb0I7O2dCQUN2QyxLQUFLLEdBQUcsbUJBQUEsS0FBSyxDQUFDLE1BQU0sRUFBb0I7WUFDOUMsS0FBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqRCxDQUFDLEVBQUE7UUFFTyxxQkFBZ0I7Ozs7UUFBRyxVQUFDLEtBQXFCOzs7Z0JBRXpDLEtBQUssR0FBcUIsbUJBQUEsS0FBSyxDQUFDLE1BQU0sRUFBb0I7O2dCQUMxRCxVQUFVLEdBQUcsQ0FBQyxLQUFLLENBQUMsYUFBYSxJQUFJLENBQUMsbUJBQU0sTUFB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SSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3JFLENBQUM7O2dCQWxIRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLG1CQUFtQjtvQkFDN0IsUUFBUSxFQUFFLHFCQUFxQjtvQkFDL0IsU0FBUyxFQUFFO3dCQUNULHVCQUF1QjtxQkFDeEI7aUJBQ0Y7Ozs7Z0JBdEJtQixVQUFVO2dCQUtyQixlQUFlLHVCQXdCbkIsTUFBTSxTQUFDLFVBQVU7Ozt3QkFBQyxjQUFNLE9BQUEsZUFBZSxFQUFmLENBQWUsRUFBQzs7SUFzRzdDLDBCQUFDO0NBQUEsQUFuSEQsSUFtSEM7U0E1R1ksbUJBQW1COzs7Ozs7SUFFOUIsMkNBQTZCOzs7OztJQWU3Qiw4Q0FHQzs7Ozs7SUFFRCwrQ0FXQzs7Ozs7SUE1QkMsMENBQStCOzs7OztJQUMvQiw0Q0FBaUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEluamVjdCwgZm9yd2FyZFJlZiwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBJQkFOIGZyb20gJ2liYW4nO1xuaW1wb3J0IHsgTkdfVkFMSURBVE9SUyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IFZhbGlkYXRvciB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuaW1wb3J0IHsgTnhNYXNrRGlyZWN0aXZlIH0gZnJvbSAnLi9tYXNrLmRpcmVjdGl2ZSc7XG5cbmV4cG9ydCBjb25zdCBOWF9JQkFOX01BU0tfVkFMSURBVE9SUzogYW55ID0ge1xuICBwcm92aWRlOiBOR19WQUxJREFUT1JTLFxuICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBOeEliYW5NYXNrRGlyZWN0aXZlKSxcbiAgbXVsdGk6IHRydWVcbn07XG5cbi8qKlxuICogVG8gdXNlIHRoZSBgTnhJYmFuTWFza0RpcmVjdGl2ZWAsIHlvdSBoYXZlIHRvIGluc3RhbGwgdGhlICoqcGVlciBkZXBlbmRlbmN5KiogYGliYW4uanNgLlxuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdpbnB1dFtueEliYW5NYXNrXScsXG4gIGV4cG9ydEFzOiAnbnhJYmFuTWFza0RpcmVjdGl2ZScsXG4gIHByb3ZpZGVyczogW1xuICAgIE5YX0lCQU5fTUFTS19WQUxJREFUT1JTXG4gIF1cbn0pXG5leHBvcnQgY2xhc3MgTnhJYmFuTWFza0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgVmFsaWRhdG9yIHtcblxuICBwcml2YXRlIF9jb3VudHJ5Q29kZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX2VsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IE54TWFza0RpcmVjdGl2ZSkpIHByaXZhdGUgbWFza0RpcmVjdGl2ZTogTnhNYXNrRGlyZWN0aXZlXG4gICkge1xuICAgIHRoaXMubWFza0RpcmVjdGl2ZS5yZWdpc3RlckFmdGVySW5wdXRIb29rKHRoaXMuX2FmdGVySW5wdXRIb29rKTtcbiAgICB0aGlzLm1hc2tEaXJlY3RpdmUucmVnaXN0ZXJCZWZvcmVQYXN0ZUhvb2sodGhpcy5fYmVmb3JlUGFzdGVIb29rKTtcblxuICAgIHRoaXMubWFza0RpcmVjdGl2ZS5jdmFNb2RlbENoYW5nZS5zdWJzY3JpYmUoKHZhbHVlOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IGVudGVyZWRDb3VudHJ5Q29kZSA9IHRoaXMubWFza0RpcmVjdGl2ZS5nZXRNYXNrZWRTdHJpbmcodmFsdWUpLnN1YnN0cigwLCAyKTtcbiAgICAgIHRoaXMuX3NldENvdW50cnlDb2RlKGVudGVyZWRDb3VudHJ5Q29kZSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9hZnRlcklucHV0SG9vayA9IChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgIGNvbnN0IGlucHV0ID0gZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgdGhpcy5fc2V0Q291bnRyeUNvZGUoaW5wdXQudmFsdWUuc3Vic3RyKDAsIDIpKTtcbiAgfVxuXG4gIHByaXZhdGUgX2JlZm9yZVBhc3RlSG9vayA9IChldmVudDogQ2xpcGJvYXJkRXZlbnQpID0+IHtcbiAgICAvLyBjaGFuZ2UgdGhlIGNvdW50cnkgY29kZSBoZXJlIGlmIG5lY2Vzc2FyeVxuICAgIGNvbnN0IGlucHV0OiBIVE1MSW5wdXRFbGVtZW50ID0gZXZlbnQudGFyZ2V0IGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgY29uc3QgcGFzdGVkRGF0YSA9IChldmVudC5jbGlwYm9hcmREYXRhIHx8ICg8YW55PiB3aW5kb3cpLmNsaXBib2FyZERhdGEpLmdldERhdGEoJ3RleHQnKTtcblxuICAgIGNvbnN0IGVudGVyZWRDb3VudHJ5Q29kZSA9IChcbiAgICAgIHRoaXMubWFza0RpcmVjdGl2ZS5lbGVtZW50UmVmVmFsdWUuc3Vic3RyKDAsIGlucHV0LnNlbGVjdGlvblN0YXJ0KVxuICAgICAgKyB0aGlzLm1hc2tEaXJlY3RpdmUuZ2V0TWFza2VkU3RyaW5nKHBhc3RlZERhdGEsIGlucHV0LnNlbGVjdGlvblN0YXJ0KVxuICAgICkuc3Vic3RyKDAsIDIpO1xuXG4gICAgdGhpcy5fc2V0Q291bnRyeUNvZGUoZW50ZXJlZENvdW50cnlDb2RlKTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldENvdW50cnlDb2RlKGNvZGU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvZGUgPSBjb2RlLnRvVXBwZXJDYXNlKCk7XG4gICAgaWYgKGNvZGUubGVuZ3RoID09PSAyICYmIHRoaXMuX2NvdW50cnlDb2RlICE9PSBjb2RlKSB7XG4gICAgICBpZiAodGhpcy5fY291bnRyeUNvZGVFeGlzdHMoY29kZSkpIHtcbiAgICAgICAgdGhpcy5fY291bnRyeUNvZGUgPSBjb2RlO1xuICAgICAgICB0aGlzLm1hc2tEaXJlY3RpdmUuc2V0TWFzayh0aGlzLl9nZXRNYXNrKHRoaXMuX2NvdW50cnlDb2RlKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9jb3VudHJ5Q29kZSA9IG51bGw7XG4gICAgICAgIHRoaXMubWFza0RpcmVjdGl2ZS5zZXRNYXNrKCdTUycpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIC8vIHNldCBvbmx5IGZpcnN0IHR3byBsZXR0ZXJzIGFzIEkgZG9uJ3Qga25vdyBhIGNvdW50cnkgeWV0XG4gICAgdGhpcy5tYXNrRGlyZWN0aXZlLm1hc2sgPSAnU1MnO1xuICAgIHRoaXMubWFza0RpcmVjdGl2ZS5jb252ZXJ0VG8gPSAndXBwZXInO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0TWFzayhjb3VudHJ5Q29kZTogc3RyaW5nKSB7XG4gICAgLy8gdGhlIGNvdW50cnlTcGVjcyBvZiBhIGNvdW50cnkgY29udGFpbjogY291bnRyeUNvZGUgKFwiREVcIiksIGxlbmd0aCAoMjIpLCBzdHJ1Y3R1cmUgKFwiRjA4RjEwXCIpXG4gICAgLy8gYW5kIGFuIGV4YW1wbGUgYmVsb25naW5nIHRvIGVhY2ggY291bnRyeVxuICAgIGNvbnN0IGNvdW50cnlTcGVjcyA9IElCQU5bJ2NvdW50cmllcyddW2NvdW50cnlDb2RlXTtcblxuICAgIC8vICdTUycgZm9yIGNvdW50cnkgY29kZSArICcwMCcgZm9yIElCQU4gY2hlY2tzdW1cbiAgICBsZXQgbWFzayA9ICdTUzAwJztcblxuICAgIC8vIHNwbGl0IHVwIGFmdGVyIGV2ZXJ5IHRoaXJkIGNoYXJhY3RlclxuICAgIGNvbnN0IGNoYXJhY3RlckRlZnMgPSBjb3VudHJ5U3BlY3NbJ3N0cnVjdHVyZSddLm1hdGNoKC8uezEsM30vZyk7XG5cbiAgICBjaGFyYWN0ZXJEZWZzLmZvckVhY2goY2hhckRlZiA9PiB7XG4gICAgICBjb25zdCBjaGFyYWN0ZXIgPSBjaGFyRGVmWzBdO1xuICAgICAgY29uc3QgY291bnQgPSBOdW1iZXIoY2hhckRlZi5zdWJzdHJpbmcoMSwgMykpO1xuXG4gICAgICBzd2l0Y2ggKGNoYXJhY3Rlcikge1xuICAgICAgICAvLyBbMC05XVxuICAgICAgICBjYXNlICdGJzogbWFzayA9IG1hc2sgKyAnMCcucmVwZWF0KGNvdW50KTsgYnJlYWs7XG4gICAgICAgIC8vIFswLTlBLVphLXpdXG4gICAgICAgIGNhc2UgJ0EnOiBtYXNrID0gbWFzayArICdBJy5yZXBlYXQoY291bnQpOyBicmVhaztcbiAgICAgICAgLy8gW0EtWl1cbiAgICAgICAgLy8gJ1MnIGluIG54TWFzayBkb2VzIGFjY2VwdCBhbHNvIFthLXpdLlxuICAgICAgICAvLyBUaGVyZSBpcyBubyBvcHRpb24gZm9yIG9ubHkgYWNjZXB0aW5nIGNhcGl0YWwgbGV0dGVycyBhdCB0aGUgbW9tZW50LlxuICAgICAgICBjYXNlICdVJzogbWFzayA9IG1hc2sgKyAnUycucmVwZWF0KGNvdW50KTsgYnJlYWs7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBpbnNlcnQgd2hpdGVzcGFjZXMgYWZ0ZXIgZXZlcnkgNCBjaGFyYWN0ZXJzXG4gICAgbWFzayA9IG1hc2subWF0Y2goLy57MSw0fS9nKS5qb2luKCcgJyk7XG5cbiAgICByZXR1cm4gbWFzaztcbiAgfVxuXG4gIHByaXZhdGUgX2NvdW50cnlDb2RlRXhpc3RzKGNvdW50cnlDb2RlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKCEhSUJBTlsnY291bnRyaWVzJ11bY291bnRyeUNvZGVdKTtcbiAgfVxuXG4gIHByaXZhdGUgX3ZhbGlkYXRlRm4oKSB7XG4gICAgY29uc3QgZW50ZXJlZENvdW50cnlDb2RlID0gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnZhbHVlLnN1YnN0cigwLCAyKTtcbiAgICBpZiAoZW50ZXJlZENvdW50cnlDb2RlLmxlbmd0aCA9PT0gMiAmJiAhdGhpcy5fY291bnRyeUNvZGVFeGlzdHMoZW50ZXJlZENvdW50cnlDb2RlKSkge1xuICAgICAgLy8gaW1tZWRpYXRlbHkgc2hvdyBlcnJvciB0byB1c2VyXG4gICAgICB0aGlzLm1hc2tEaXJlY3RpdmUuX3RvdWNoKCk7XG4gICAgICByZXR1cm4geyBueEliYW5JbnZhbGlkQ291bnRyeUVycm9yOiAnbm8gdmFsaWQgY291bnRyeSBjb2RlJ307XG4gICAgfVxuICAgIGlmICghSUJBTi5pc1ZhbGlkKHRoaXMubWFza0RpcmVjdGl2ZS5nZXRVbm1hc2tlZFZhbHVlKCkpKSB7XG4gICAgICByZXR1cm4geyBueEliYW5QYXJzZUVycm9yOiAnbm8gdmFsaWQgaWJhbid9O1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKiBAZG9jcy1wcml2YXRlICovXG4gIHZhbGlkYXRlKCkge1xuICAgIHJldHVybiB0aGlzLm1hc2tEaXJlY3RpdmUudmFsaWRhdGVNYXNrID8gdGhpcy5fdmFsaWRhdGVGbigpIDogbnVsbDtcbiAgfVxufVxuIl19